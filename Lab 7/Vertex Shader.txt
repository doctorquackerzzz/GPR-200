#version 300 es

//LIGHT INITIALIZATIONS TAKEN FROM LAB 4
//TEXTURES TAKEN FROM LAB 5 // PROFESSOR BUCKSTEIN'S ANNOUNCEMENT IN CANVAS

// Input attributes
layout (location = 0) in vec4 aPosition;
layout (location = 1) in vec3 aNormal;
layout (location = 2) in vec2 aTexCoord;

// Varyings
out vec4 vColor, vPosition;
out vec3 vNormal;
out vec2 vTexCoord;

// Uniforms
uniform mat4 uModelMatrix, uViewMatrix, uViewProjMatrix;
uniform sampler2D uTexture;

// sPointLight: data structure to hold info about lights
// center:    center of light
// color:     color of light
// intensity: intensity of light

struct light
{
	vec3 lcenter, lcolor;
	float lintensity;
};

// initLight: function to initialize a light
// 	center:    input center of light
// 	color:     input color of light
// 	intensity: input intensity of light

light initLight(in vec3 pos, in vec3 color, in float intensity)
{
	light temp;
	
	temp.lcenter = pos;
	temp.lcolor = color;
	temp.lintensity = intensity;
	
	return temp;
}
vec3 lambertReflect (in light lighter, in vec3 normal)
{
		vec3 lightVec = normalize(lighter.lcenter); //light vector normalization at center
	
		float diffCoeff = max(0.0, dot(vNormal, lightVec)); //diffusion coefficient

		//attenuation
		vec3 attenuation = 1.0 / (vec3(lighter.lcenter / lighter.lintensity)+ vec3(lighter.lcenter / lighter.lintensity) * vec3(lighter.lcenter / lighter.lintensity));
		
		//returns the diffusion intensity which is the product of this
		return diffCoeff * attenuation;
}

vec3 reflectLighter(in light lighter, in vec3 normal)
{
	//light vector declaration
	vec3 lightVec = normalize(lighter.lcenter);
	
	//reflect function for both the light vector and the vNormal vector
	vec3 reflectLight = reflect(-lightVec, vNormal);
	return reflectLight;
}


void main()
{
	// Variable declarations
	// Constant to determine number of lights
	const int LIGHTER = 3;
	
	light lighter[LIGHTER];
	
	//model view matrix and clip space  functions
	mat4 modelViewMatrix = uViewMatrix * uModelMatrix;
	vec4 pos_clip = uViewProjMatrix * uModelMatrix * aPosition;	
	
	//final color and position vector initialization
	vec4 finalColor, position;
	
	//light position, view vector and normal initialization
	vec3 lightPosition, viewVec, normal;
	
	//specular coefficient initialization
	float specularCoeff;
	
	// position in both object space and view space by attributes
	position = aPosition;
	//position = modelViewMatrix * aPosition;
	
	normal = aNormal;
	//normal = mat3(modelViewMatrix) * aNormal;
	
	// Main lighting calculation loop
	for (int i = 0; i < LIGHTER; i++)
	{
		//object space light position
		//lightPosition = vec3(i, i, 1);
		
		// view space light position
		lightPosition = mat3(modelViewMatrix) * vec3(i, i, 1);
	
		// Initialize at given position, white light, 1.5 intensity
		lighter[i] = initLight(lightPosition, vec3(1), 1.5);
		
		lambertReflect(lighter[i], vNormal);
		
		//view vector calculation
		viewVec = normalize(lighter[i].lcenter - vec3(vPosition));
		
		reflectLighter(lighter[i],vNormal);
		// spec coefficient calculation
		specularCoeff = dot(reflectLighter(lighter[i], vNormal), viewVec) * 0.5 + 0.5;
		specularCoeff *= specularCoeff;
		specularCoeff *= specularCoeff;

		// Calculate final color for this light
		finalColor += texture(uTexture, aTexCoord) * 
			      vec4(lambertReflect(lighter[i], vNormal) + specularCoeff * vec3(0) * lighter[i].lcolor, 1);
	}
	
	// Factor in global light
	finalColor += 0.15 * vec4(1);
	
	// VARYING
	vColor = finalColor;
	vPosition = position;
	vNormal = normal;
	vTexCoord = aTexCoord;
		
	//Position set in clip space
	gl_Position = pos_clip;
}